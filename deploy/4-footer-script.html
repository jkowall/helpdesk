<!--
  PAESSLER HELPDESK – AI WIDGET SCRIPT (FOOTER)
  Paste into: Admin → Portals → Appearance → Pages → Footer
  Place this BEFORE the {{ footer }} tag.

  CSP NOTE: If using the Marina theme, add nonce="{{portal.nonce}}" to both
  script tags below. Uncomment the nonce versions and remove the plain ones.
-->

<!-- Embrace AI Web Component Library -->
<script type="module" src="https://js.dev.embrace.ai/v1/elements.js"></script>

<!-- Widget Logic -->
<script>
    (function () {
        var container = document.getElementById('embrace-widget-container');
        var expandBtn = document.getElementById('btn-expand');
        var backBtn = document.getElementById('btn-back-helpdesk');
        var heroChatField = document.getElementById('hero-chat-field');
        var heroChatSubmit = document.getElementById('hero-chat-submit');

        if (!container || !expandBtn) return;

        expandBtn.addEventListener('click', function () {
            toggleChat();
        });

        if (backBtn) {
            backBtn.addEventListener('click', function () {
                if (container.classList.contains('widget-fullscreen')) {
                    toggleChat();
                }
            });
        }

        function toggleChat() {
            container.classList.toggle('widget-fullscreen');
        }

        // Open fullscreen chat, optionally with a pre-filled message
        window.openFullscreenChat = function (message) {
            if (container && !container.classList.contains('widget-fullscreen')) {
                toggleChat();
            }
            if (message) {
                setTimeout(function () {
                    var chatEl = document.querySelector('embrace-chat');
                    if (chatEl && chatEl.shadowRoot) {
                        var input = chatEl.shadowRoot.querySelector('textarea, input[type="text"]');
                        if (input) {
                            input.value = message;
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                }, 600);
            }
        };

        // Hero chat input — opens fullscreen chat with typed message
        if (heroChatSubmit) {
            heroChatSubmit.addEventListener('click', function () {
                var msg = heroChatField ? heroChatField.value.trim() : '';
                if (msg) {
                    openFullscreenChat(msg);
                    heroChatField.value = '';
                } else {
                    openFullscreenChat();
                }
            });
        }

        if (heroChatField) {
            heroChatField.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (heroChatSubmit) heroChatSubmit.click();
                }
            });
        }

        // Suggested topic pills — open fullscreen chat with topic text
        var pills = document.querySelectorAll('.topic-pill');
        for (var i = 0; i < pills.length; i++) {
            pills[i].addEventListener('click', function () {
                var topic = this.getAttribute('data-topic');
                openFullscreenChat(topic);
            });
        }
    })();
</script>

<!--
  ── CSP/NONCE VERSIONS ──────────────────────────────────────────
  If your Freshdesk portal enforces Content Security Policy (Marina theme),
  replace the script tags above with these nonce-enabled versions:

  <script type="module" src="https://js.dev.embrace.ai/v1/elements.js"
          nonce="{{portal.nonce}}"></script>

  <script nonce="{{portal.nonce}}">
    // ... (same JS as above)
  </script>
-->